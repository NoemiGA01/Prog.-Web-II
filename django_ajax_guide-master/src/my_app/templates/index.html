{% extends "base.html" %}

{% block content %}

<div class="container-fluid">
    <form id="friend-form">
        <div class="row">
            {% csrf_token %}
            {% for field in form %}
            <div class="form-group col-4">
                <label class="col-12">{{ field.label }}</label>
                {{ field }}
            </div>
            {% endfor %}

            <div class="col text-center">
                <input type="submit" class="btn btn-primary" value="Create Friend" />
            </div>

        </div>
        <form>
</div>

<hr />

<div class="container-fluid">
    <table class="table table-striped table-sm" id="my_friends">
        <thead>
            <tr>
                <th>Nick name</th>
                <th>First name</th>
                <th>Last name</th>
                <th>Likes</th>
                <th>DOB</th>
                <th>lives in</th>
            </tr>
        </thead>
        <tbody>
            {% for friend in friends %}
            <tr>
                <td>{{friend.nick_name}}</td>
                <td>{{friend.first_name}}</td>
                <td>{{friend.last_name}}</td>
                <td>{{friend.likes}}</td>
                <td>{{friend.dob | date:"Y-m-d"}}</td>
                <td>{{friend.lives_in}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>
{% endblock content %}


{% block javascript %}
<script>
    $(document).ready(function () {
        /*
            On submiting the form, send the POST ajax
            request to server and after successfull submission
            display the object.
        */
        async function postFriend(serializedData) {
            try {
                const response = await fetch("{% url 'post_friend' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'  // Este encabezado es necesario
                    },
                    body: serializedData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error desconocido');
                }

                const data = await response.json();
                console.log('Respuesta del servidor:', data);

                $("#friend-form").trigger('reset');
                $("#id_nick_name").focus();

                const instance = JSON.parse(data.instance);
                const fields = instance[0].fields;
                $("#my_friends tbody").prepend(`
            <tr>
                <td>${fields.nick_name || ""}</td>
                <td>${fields.first_name || ""}</td>
                <td>${fields.last_name || ""}</td>
                <td>${fields.likes || ""}</td>
                <td>${fields.dob || ""}</td>
                <td>${fields.lives_in || ""}</td>
            </tr>
        `);
            } catch (error) {
                console.error('Error:', error);
                alert(`Hubo un problema: ${error.message}`);
            }
        }




        // Asociar la función al evento de envío del formulario
        $("#friend-form").submit(function (e) {
            e.preventDefault();
            const serializedData = $(this).serialize();
            postFriend(serializedData);
        });




        /*
        On focus out on input nickname,
        call AJAX get request to check if the nickName
        already exists or not.
        */
        async function validateNickname(nick_name) {
            try {
                const response = await fetch("{% url 'validate_nickname' %}?nick_name=" + encodeURIComponent(nick_name), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // Este encabezado es crucial
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Respuesta inesperada del servidor:', errorText);
                    throw new Error('Error en la validación del nickname');
                }

                const data = await response.json();
                console.log('Respuesta del servidor:', data);  // Depuración en el cliente

                if (!data.valid) {
                    alert(data.message || "No puedes crear un amigo con el mismo nickname");
                    const nickNameInput = $("#id_nick_name");
                    nickNameInput.val("").focus();
                }
            } catch (error) {
                console.error('Error:', error.message);
                alert(`Hubo un problema: ${error.message}`);
            }
        }


        // Asociar la función al evento de `focusout`
        $("#id_nick_name").focusout(function (e) {
            e.preventDefault();
            const nick_name = $(this).val();
            if (nick_name) {
                validateNickname(nick_name);
            }
        });



    })
</script>
{% endblock javascript %}